#!/usr/bin/env bash

EXPECTED="/Users/howe/Documents/software/server"

if [ "$PWD" != "$EXPECTED" ]; then
    echo "Error: must be run from $EXPECTED" >&2
    exit 1
fi

# Copy the current server code to "comp3007@howe:/opt/comp3007/server".
# Sends an "archive", i.e. a copy meeting the export restricitons in .gitattributes.
git archive --format=tar HEAD |
    ssh comp3007@howe '
  set -e
  DEST="/opt/comp3007/server"
  TMPDIR="$(mktemp -d)"

  # Extract the new version into a temporary directory
  tar -x -C "$TMPDIR"

  # Delete everything currently in the destination
  rm -rf "$DEST"

  # Move the new version into place
  mv "$TMPDIR" "$DEST"
'

# Copy server-config.toml.
scp "../deploy/server-config.toml" comp3007@howe:/opt/comp3007/server

ssh comp3007@howe /opt/comp3007/server/bin/update-serverside

#!/usr/bin/env bash

EXPECTED_LOCAL_DIR="/Users/howe/Documents/software/server"
HOST_USER="comp3007"
HOST="howe"
HOST_SRC_DIR="/opt/comp3007/server"

if [[ -v $1 ]]; then
    echo "Error: git commit message required."
    exit 1
fi
commit_msg="$1"

if [ "$PWD" != "$EXPECTED_LOCAL_DIR" ]; then
    echo "Error: must be run from $EXPECTED" >&2
    exit 1
fi

echo "Committing repo..."
git add .
git commit -a -m "$commit_msg"
# git commit --verbose -a -m "$1"
git push

# Copy the current server code to "comp3007@howe:/opt/comp3007/server".
# Sends an "archive", i.e. a copy meeting the export restricitons in .gitattributes.
ssh_dst="$HOST_USER@$HOST"
echo "Copying server code to host"
git archive --format=tar HEAD |
    ssh $ssh_dst '
  set -e
  DEST="/opt/comp3007/server"
  TMPDIR="$(mktemp -d)"

  # Extract the new version into a temporary directory
  tar -x -C "$TMPDIR"

  # Delete everything currently in the destination
  rm -rf "$DEST"

  # Move the new version into place
  mv "$TMPDIR" "$DEST"
'

# Copy server-config.toml.
scp "../deployment-configs/server-config-scs.toml" comp3007@howe:/opt/comp3007/server/server-config.toml

# Rebuild/restart on server
ssh ssh_dst '
cd /opt/comp3007/server || exit 1
go build .
sudo systemctl restart comp3007
sudo systemctl status --no-pager comp3007 || true
'
